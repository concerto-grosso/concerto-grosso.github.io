<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple_touch_icon_next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon_32x32_next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_16x16_next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/serach.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js" defer></script><link rel="canonical" href="http://example.com/linux/the_linux_programming_interface_a_linux_and_unix_system_programming_handbook_chpt_17/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/linux/the_linux_programming_interface_a_linux_and_unix_system_programming_handbook_chpt_17/","path":"linux/the_linux_programming_interface_a_linux_and_unix_system_programming_handbook_chpt_17/","title":"《Linux/UNIX系统编程手册》第17章 访问控制列表"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>《Linux/UNIX系统编程手册》第17章 访问控制列表 |</title><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script><script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script><script src="/js/third-party/search/local-search.js" defer></script><script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/js/third-party/math/mathjax.js" defer></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title"></p><i class="logo-line"></i></a></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#acl%E6%9D%83%E9%99%90%E6%A3%80%E6%9F%A5%E7%AE%97%E6%B3%95"><span class="nav-text">17.1 ACL权限检查算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#acl%E7%9A%84%E6%96%87%E6%9C%AC%E5%BD%A2%E5%BC%8F"><span class="nav-text">17.2 ACL的文本形式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#acl_mask%E6%9D%A1%E7%9B%AE"><span class="nav-text">17.3 ACL_MASK条目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4getfacl%E5%92%8Csetfacl"><span class="nav-text">17.4 命令getfacl和setfacl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4acl%E5%92%8C%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA"><span class="nav-text">17.5 默认ACL和文件创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#acl%E5%AE%9E%E7%8E%B0%E9%99%90%E5%88%B6"><span class="nav-text">17.6 ACL实现限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#acl-api"><span class="nav-text">17.7 ACL API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%86%E6%96%87%E4%BB%B6%E7%9A%84acl%E6%8F%90%E5%8F%96%E5%88%B0%E5%86%85%E5%AD%98%E5%92%8C%E6%9B%B4%E6%96%B0%E6%96%87%E4%BB%B6%E7%9A%84acl"><span class="nav-text">17.7.1 将文件的ACL提取到内存和更新文件的ACL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A3%80%E7%B4%A2%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84acl%E6%9D%A1%E7%9B%AE"><span class="nav-text">17.7.2 检索内存中的ACL条目</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A3%80%E7%B4%A2%E5%92%8C%E4%BF%AE%E6%94%B9acl%E6%9D%A1%E7%9B%AE%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="nav-text">17.7.3 检索和修改ACL条目的属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%92%8C%E5%88%A0%E9%99%A4acl%E6%9D%A1%E7%9B%AE"><span class="nav-text">17.7.4 创建和删除ACL条目</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84acl%E4%B8%8E%E6%96%87%E6%9C%AC%E5%BD%A2%E5%BC%8Facl%E4%B9%8B%E9%97%B4%E7%9A%84%E8%BD%AC%E6%8D%A2"><span class="nav-text">17.7.5 内存中的ACL与文本形式ACL之间的转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#acl-api%E4%B8%AD%E7%9A%84%E5%85%B6%E4%BB%96%E5%87%BD%E6%95%B0"><span class="nav-text">17.7.6 ACL API中的其他函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E7%A8%8B%E5%BA%8F"><span class="nav-text">17.7.7 示例程序</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name"></p><div class="site-description" itemprop="description">这只是个人学习总结，难免出错，欢迎指出，邮箱：concerto-grosso@outlook.com</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">72</span> <span class="site-state-item-name">文章</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div></nav></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/linux/the_linux_programming_interface_a_linux_and_unix_system_programming_handbook_chpt_17/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""><meta itemprop="description" content="这只是个人学习总结，难免出错，欢迎指出，邮箱：concerto-grosso@outlook.com"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="《Linux&#x2F;UNIX系统编程手册》第17章 访问控制列表 | null"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">《Linux/UNIX系统编程手册》第17章 访问控制列表</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-02-16 00:00:00" itemprop="dateCreated datePublished" datetime="2025-02-16T00:00:00+08:00">2025-02-16</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-02-19 00:00:00" itemprop="dateModified" datetime="2025-02-19T00:00:00+08:00">2025-02-19</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a> </span></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>12k</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>　　有时，应用程序需要将权限授予特定的用户或组。为此，很多UNIX系统都实现了<strong>访问控制列表</strong> (ACL)，作为传统文件权限体系的扩展 (见15.4)。ACL允许为单个用户或组指定权限。Linux从内核2.6开始支持ACL。</p><p>　　所有文件系统的ACL都是可选项，由文件系统菜单下的内核配置选项控制。Reiserfs对ACL的支持需要内核2.6.7及以上版本。为了在ext2、ext3、ext4和Reiserfs中创建ACL，通过命令<code>mount</code>挂载这些文件系统时需要使用选项<code>-o acl</code>。</p><p>　　每个ACL都包含一系列ACL条目，每个条目都定义了1个用户或1个组的文件权限。每个ACL条目都包含<span style="background-color:#ff0">标签类型</span>、(可选的) <span style="background-color:#ff0">标签限定符</span>和<span style="background-color:#ff0">权限集</span>。</p><p>　　● 标签类型表示该条目是应用于用户、组还是其他权限类别。</p><p>　　● 标签限定符是用户ID或组ID。</p><p>　　● 权限集指定授予该条目的权限 (读、写和执行权限)。</p><table><thead><tr><th>标签类型</th><th>标签限定符</th><th>权限</th></tr></thead><tbody><tr><td><code>ACL_USER_OBJ</code></td><td></td><td><code>rwx</code></td></tr><tr><td><code>ACL_USER</code></td><td><code>1007</code></td><td><code>r--</code></td></tr><tr><td><code>ACL_USER</code></td><td><code>1010</code></td><td><code>rwx</code></td></tr><tr><td><code>ACL_GROUP_OBJ</code></td><td></td><td><code>rwx</code></td></tr><tr><td><code>ACL_GROUP</code></td><td><code>102</code></td><td><code>r--</code></td></tr><tr><td><code>ACL_GROUP</code></td><td><code>103</code></td><td><code>-w-</code></td></tr><tr><td><code>ACL_GROUP</code></td><td><code>109</code></td><td><code>--x</code></td></tr><tr><td><code>ACL_MASK</code></td><td></td><td><code>rw-</code></td></tr><tr><td><code>ACL_OTHER</code></td><td></td><td><code>r--</code></td></tr></tbody></table><p>　　标签类型的值只能是<code>ACL_USER_OBJ</code>、<code>ACL_USER</code>、<code>ACL_GROUP_OBJ</code>、<code>ACL_GROUP</code>、<code>ACL_MASK</code>或<code>ACL_OTHER</code>。<strong>组类</strong>是ACL中的所有<code>ACL_USER</code>、<code>ACL_GROUP</code>和<code>ACL_GROUP_OBJ</code>条目的集合。</p><p>　　● <code>ACL_USER_OBJ</code>表示权限授予文件所有者的权限。1个ACL只有1个<code>ACL_USER_OBJ</code>条目。该条目对应传统文件权限体系中的的用户类别权限。</p><p>　　● <code>ACL_USER</code>表示授予标签限定符指定的用户的权限。1个ACL可以有任意个<code>ACL_USER</code>条目，但每个用户最多只能有1个对应的<code>ACL_USER</code>条目。</p><p>　　● <code>ACL_GROUP_OBJ</code>表示授予文件所属组的权限。1个ACL只有1个<code>ACL_GROUP_OBJ</code>条目。该条目对应传统文件权限体系中的的组类别权限，除非ACL也包含<code>ACL_MASK</code>条目。</p><p>　　● <code>ACL_GROUP</code>表示授予标签限定符指定的组的权限。1个ACL可以有任意个<code>ACL_GROUP</code>条目，但每个组最多只能有1个对应的<code>ACL_GROUP</code>条目。</p><p>　　● <code>ACL_MASK</code>表示授予组类的权限的上限。1个ACL最多只能有1个<code>ACL_MASK</code>条目。若ACL中包含<code>ACL_USER</code>或<code>ACL_GROUP</code>条目，则该ACL中必须有<code>ACL_MASK</code>条目；否则，<code>ACL_MASK</code>条目是可选的。</p><p>　　● <code>ACL_OTHER</code>表示授予其他用户的权限。1个ACL只有1个<code>ACL_OTHER</code>条目。该条目对应传统文件权限体系中的的其他类别权限。</p><p>　　标签限定符仅适用于<code>ACL_USER</code>和<code>ACL_GROUP</code>条目。</p><span id="more"></span><p>　　ACL分为<span style="background-color:#ff0">访问ACL</span>和<span style="background-color:#ff0">默认ACL</span>。当进程访问有ACL的文件时，访问ACL决定进程的权限。默认ACL仅适用于目录，目录的默认ACL是否存在决定在该目录下创建的文件和子目录的ACL和权限。Linux将ACL实现为系统扩展属性，访问和默认ACL分别存储为扩展属性<code>system.posix_acl_access</code>和<code>system.posix_acl_default</code>。</p><p>　　<span style="background-color:#ff0">最小ACL</span>是等同于传统文件权限集的ACL (仅包含<code>ACL_USER_OBJ</code>、<code>ACL_GROUP_OBJ</code>和<code>ACL_OTHER</code>条目)。<span style="background-color:#ff0">扩展ACL</span>是包含<code>ACL_USER</code>、<code>ACL_GROUP</code>和<code>ACL_MASK</code>条目的ACL。最小ACL存储为传统文件权限位。</p><p>　　ACL从未正式成为UNIX标准的一部分。POSIX.1e草案旨在详细说明ACL API，POSIX.2c草案旨在详细说明ACL shell命令 (以及能力等其他特性)，但都失败了，并且这些草案被撤回了。尽管如此，很多UNIX实现 (和Linux) 基于这些草案实现了ACL (通常是基于最终版Draft 17)。但是，由于各个ACL实现不同 (部分原因是草案不完整)，开发使用ACL的可移植应用程序有些困难。</p><h3 id="acl权限检查算法">17.1 ACL权限检查算法</h3><p>　　对有ACL的文件执行的权限检查与传统文件权限模型类似 (见15.4.3)。检查按照如下顺序进行，并且遇到匹配的规则就立即停止：</p><p>　　1) 若进程是特权进程，则授予所有权限。但是，存在1个例外，即当执行文件时，需要至少有1个ACL条目授予执行权限，特权进程才会拥有执行权限。</p><p>　　2) 若进程的有效用户ID与文件的用户ID匹配，则授予进程<code>ACL_USER_OBJ</code>条目指定的权限 。</p><p>　　3) 若进程的有效用户ID与某个<code>ACL_USER</code>条目的标签限定符匹配，则授予进程该<code>ACL_USER</code>条目与<code>ACL_MASK</code>条目进行与操作<code>&amp;</code>得到的权限。</p><p>　　4) 若进程的组ID (即有效组ID和辅助组ID) 与文件的组ID匹配，则授予进程<code>ACL_GROUP_OBJ</code>条目指定的权限 (ACL包含<code>ACL_MASK</code>条目时还要与<code>ACL_MASK</code>条目进行与操作<code>&amp;</code>)。</p><p>　　5) 若进程的组ID与某个<code>ACL_GROUP</code>条目的标签限定符匹配，则授予进程该<code>ACL_GROUP</code>条目与<code>ACL_MASK</code>条目进行与操作<code>&amp;</code>得到的权限。</p><p>　　6) 否则，授予进程<code>ACL_OTHER</code>条目指定的权限。</p><h3 id="acl的文本形式">17.2 ACL的文本形式</h3><p>　　当通过命令<code>setfacl</code>和<code>getfacl</code>以及相关库函数来控制ACL时，需要指定ACL条目的文本表示。允许的文本表示包括<span style="background-color:#ff0">长文本形式</span>和<span style="background-color:#ff0">短文本形式</span>。</p><p>　　● 对于长文本形式的ACL，1行包含1个ACL条目 (和以<code>#</code>开头的注释)。命令<code>getfacl</code>会以长文本形式显示ACL。命令<code>setfacl –M acl-file</code>会从文件中获取长文本形式的ACL规范。</p><p>　　● 对于短文本形式的ACL，ACL条目由逗号<code>,</code>分隔。</p><p>　　这2种形式的ACL条目都包含3个部分，这3个部分由冒号<code>:</code>分隔。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tag-type:[tag-qualifier]:permissions</span><br></pre></td></tr></table></figure><p>　　<code>tag-type</code>部分对应标签类型。<code>tag-qualifier</code>部分是可选的，对应标签限定符，仅适用于<code>ACL_USER</code>和<code>ACL_GROUP</code>条目。<code>permissions</code>部分对应权限集。</p><table><thead><tr><th>标签文本形式</th><th>标签限定符</th><th>对应的标签类型</th><th>条目对象</th></tr></thead><tbody><tr><td><code>u</code>或<code>user</code></td><td>✕</td><td><code>ACL_USER_OBJ</code></td><td>文件所有者</td></tr><tr><td><code>u</code>或<code>user</code></td><td>✓</td><td><code>ACL_USER</code></td><td>指定用户</td></tr><tr><td><code>g</code>或<code>group</code></td><td>✕</td><td><code>ACL_GROUP_OBJ</code></td><td>文件所属组</td></tr><tr><td><code>g</code>或<code>group</code></td><td>✓</td><td><code>ACL_GROUP</code></td><td>指定组</td></tr><tr><td><code>m</code>或<code>mask</code></td><td>✕</td><td><code>ACL_MASK</code></td><td>组类的掩码</td></tr><tr><td><code>o</code>或<code>other</code></td><td>✕</td><td><code>ACL_OTHER</code></td><td>其他用户</td></tr></tbody></table><h3 id="acl_mask条目">17.3 <code>ACL_MASK</code>条目</h3><p>　　<code>ACL_MASK</code>条目的目的是在运行无法识别ACL的应用程序提供一致的行为。</p><p>　　假设某个文件的ACL包含以下条目：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user::rwx       # ACL_USER_OBJ</span><br><span class="line">user:paulh:r-x  # ACL_USER</span><br><span class="line">group::r-x      # ACL_GROUP_OBJ</span><br><span class="line">group:teach:--x # ACL_GROUP</span><br><span class="line">other::--x      # ACL_OTHER</span><br></pre></td></tr></table></figure><p>　　当某个程序对该文件执行命令<code>chmod(pathname, 0700)</code>时 (只有用户类别有该文件的权限)，在没有<code>ACL_MASK</code>条目的情况下，该命令的行为可以通过多种方式实现，但所有实现方式都有问题。</p><p>　　● 可以直接修改<code>ACL_GROUP_OBJ</code>和<code>ACL_USER_OBJ</code>条目，但用户<code>paulh</code>和组<code>teach</code>仍然拥有该文件的权限。</p><p>　　● 其他实现方式会将新的组类别权限设置和其他权限设置应用到ACL中的所有<code>ACL_USER</code>、<code>ACL_GROUP</code>、<code>ACL_GROUP_OBJ</code>和<code>ACL_OTHER</code>条目：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user::rwx       # ACL_USER_OBJ</span><br><span class="line">user:paulh:---  # ACL_USER</span><br><span class="line">group::---      # ACL_GROUP_OBJ</span><br><span class="line">group:teach:--- # ACL_GROUP</span><br><span class="line">other::---      # ACL_OTHER</span><br></pre></td></tr></table></figure><p>　　这样会导致无法识别ACL的应用程序无意中破坏了由能够识别ACL的应用程序创建的文件权限的语义，因为命令<code>chmod(pathname, 751)</code>不会将ACL的<code>ACL_USER</code>和<code>ACL_GROUP</code>条目恢复到旧值。</p><p>　　● 为了避免以上问题，可以通过<code>ACL_GROUP_OBJ</code>条目来限制所有<code>ACL_USER</code>和<code>ACL_GROUP</code>条目 (<code>ACL_GROUP_OBJ</code>条目是所有<code>ACL_USER</code>和<code>ACL_GROUP</code>条目的权限集的父集) 。但是，这与<code>ACL_GROUP_OBJ</code>条目的目的冲突。</p><p>　　<code>ACL_MASK</code>条目正是为了解决以上问题。虽然<code>ACL_MASK</code>条目提供了1种在运行无法识别ACL的应用程序时保留ACL信息的方法，但不能保证相反的情况。ACL的存在覆盖了传统操作对组类别权限的影响。例如，若某个文件的ACL的<code>ACL_MASK</code>条目是<code>---</code>，则对该文件执行命令<code>chmod g+rw</code>后，组类别权限不会改变。</p><h3 id="命令getfacl和setfacl">17.4 命令<code>getfacl</code>和<code>setfacl</code></h3><p>　　对于shell，可以通过命令<code>getfacl</code>来查看文件的ACL。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">umask</span> 022</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">touch</span> tfile</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">getfacl tfile</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">file: tfile</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">owner: mtk</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">group: <span class="built_in">users</span></span></span><br><span class="line">user::rw-</span><br><span class="line">group::r--</span><br><span class="line">other::r--</span><br></pre></td></tr></table></figure><p>　　在命令<code>getfacl</code>的输出中，新创建的文件的ACL是最小ACL。此外，第4~6行显示了文件名和所有权，可以通过选项<code>––omit–header</code>来不显示这些信息。</p><p>　　命令<code>setfacl</code>可以修改文件的ACL。</p><p>　　● 选项<code>-m</code>会创建新条目或修改已存在的条目。</p><p>　　● 选项<code>-R</code>会将特定ACL应用到目录下的所有文件。</p><p>　　● 选项<code>-x</code>会删除指定条目。</p><p>　　● 选项<code>-b</code>会删除所有扩展ACL条目，仅保留最小ACL条目。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">setfacl -m u:paulh:rx,g:teach:x tfile</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">getfacl --omit-header tfile</span></span><br><span class="line">user::rwx</span><br><span class="line">user:paulh:r-x</span><br><span class="line">group::r-x</span><br><span class="line">group:teach:--x</span><br><span class="line">mask::r-x</span><br><span class="line">other::--x</span><br></pre></td></tr></table></figure><p>　　根据命令<code>getfacl</code>的输出，可以看出命令<code>setfacl</code>会自动创建<code>ACL_MASK</code>条目。</p><p>　　创建了<code>ACL_USER</code>和<code>ACL_GROUP</code>条目后，ACL就变成了扩展ACL。命令<code>ls -l</code>会在传统文件权限掩码后添加1个加号<code>+</code>来表示这种情况。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">setfacl -m m::x tfile</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">getfacl --omit-header tfile</span></span><br><span class="line">user::rwx</span><br><span class="line">user:paulh:r-x      #effective:--x</span><br><span class="line">group::r-x          #effective:--x</span><br><span class="line">group:teach:--x</span><br><span class="line">mask::--x</span><br><span class="line">other::--x</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -l tfile</span></span><br><span class="line">-rwx--x--x+ 1 mtk users 0 Dec 3 15:42 tfile</span><br></pre></td></tr></table></figure><p>　　命令<code>ls -l</code>输出的是组类权限与<code>ACL_MASK</code>条目进行与操作<code>&amp;</code>后得到的结果。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">setfacl -x u:paulh,g:teach tfile</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">getfacl --omit-header tfile</span></span><br><span class="line">user::rwx</span><br><span class="line">group::r-x</span><br><span class="line">mask::r-x</span><br><span class="line">other::--x</span><br></pre></td></tr></table></figure><p>　　删除了指定条目后，命令<code>setfacl</code>还会自动将<code>ACL_MASK</code>条目修改为所有组类条目的并集。</p><p>　　为了查看和设置目录的默认ACL，可以在使用命令<code>getfacl</code>和<code>setfacl</code>时带有选项<code>-d</code>。目录的默认ACL可以通过命令<code>setfacl –k</code>删除。</p><h3 id="默认acl和文件创建">17.5 默认ACL和文件创建</h3><p>　　若目录有默认ACL，则会出现以下情况：</p><p>　　● 该目录下新创建的子目录会继承该目录的默认ACL，作为自己的默认ACL。</p><p>　　● 该目录下新创建的子目录和文件会继承该目录的默认ACL，作为自己的访问ACL。与传统文件权限位对应的ACL条目会受限于创建子目录或文件的系统调用 (例如，<code>open()</code>和<code>mkdir</code>) 的参数<code>mode</code>，这些ACL条目包括<code>ACL_USER_OBJ</code>、<code>ACL_MASK</code> (若没有<code>ACL_MASK</code>，则包括<code>ACL_GROUP_OBJ</code>) 和<code>ACL_OTHER</code>。</p><p>　　当目录有默认ACL后，进程的umask (见15.4.6) 将不会参与决定该目录下新创建的文件的访问ACL条目的权限。</p><p>　　若目录没有默认ACL，则会出现以下情况：</p><p>　　● 该目录下新创建的子目录不会有默认ACL。</p><p>　　● 该目录下新创建的子目录和文件遵循传统规则，即文件权限设置为<code>open()</code>和<code>mkdir()</code>等系统调用的参数<code>mode</code>的指定的权限减去umask指定的权限得到的结果，这会导致新文件的ACL是最小ACL。</p><h3 id="acl实现限制">17.6 ACL实现限制</h3><p>　　各种文件系统实现对ACL中的条目数施加了限制：</p><p>　　● 对于ext2、ext3和ext4，因为与文件关联的所有扩展属性的名称和值的总字节数不大于单个逻辑磁盘块的大小，并且每个ACL条目需要8字节，所以ACL中的条目数小于块大小的<span class="math inline">\(\frac{1}{8}\)</span> (ACL对应的扩展属性名占用了部分空间)，4096字节的块最多可以容纳大约500个ACL条目 (2.6.11之前的内核要求ext2和ext3的ACL的条目数上限是32)。</p><p>　　● 对于XFS，ACL的条目数上限是25。</p><p>　　● 对于Reiserfs和JFS，ACL最多可以容纳8191个条目，因为VFS要求扩展属性的值不大于64KB。</p><p>　　尽管以上文件系统允许ACL容纳更多的条目，但应该尽量避免这样，原因如下：</p><p>　　● 维护条目过多的ACL是1项复杂且容易出错的系统管理任务。</p><p>　　● 扫描ACL来匹配条目所需的时间随着ACL条目的增加而线性增加。</p><p>　　通常，可以通过在系统组文件中定义合适的组并在ACL中使用这些组来将文件的ACL条目维持在合理的数量。</p><h3 id="acl-api">17.7 ACL API</h3><p>　　POSIX.1e草案定义了大量用于控制ACL的函数和数据结构。由于它们数量巨大，这里只会介绍部分函数。</p><p>　　使用ACL API的程序需要引用头文件<code>sys/acl.h</code>。若程序使用了基于POSIX.1e草案的Linux扩展，则可能还需要引用头文件<code>acl/libacl.h</code>，并且在编译时需要带有选项<code>-lacl</code> (链接库libacl)。</p><p>　　对于Linux，ACL API被实现为控制用户空间数据结构的1组库函数 (必要时会调用<code>getxattr()</code>和<code>setxattr()</code>来检索和修改位于磁盘的存储ACL表示的系统扩展属性)。有时，应用程序会通过<code>getxattr()</code>和<code>setxattr()</code>来直接控制ACL。</p><img src="/linux/the_linux_programming_interface_a_linux_and_unix_system_programming_handbook_chpt_17/relationship_between_acl_library_functions_and_data_structures.svg"><p>　　在大多数情况下，返回值是整数 (状态) 的函数会在成功时返回0，出错时返回-1。返回值是句柄 (指针) 的函数会在出错时返回<code>NULL</code>。错误可以通过<code>errno</code>诊断。</p><p>　　<span style="background-color:#ff0">句柄</span>是用于引用对象或数据结构的某种技术的抽象术语。句柄的表示对API实现私有的 (例如，它可能是数组索引或散列值)。</p><h4 id="将文件的acl提取到内存和更新文件的acl">17.7.1 将文件的ACL提取到内存和更新文件的ACL</h4><p>　　函数<code>acl_get_file()</code>会检索参数<code>pathname</code>指定的文件的ACL副本。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">acl_t</span> acl;</span><br><span class="line">acl = acl_get_file(pathname, type);</span><br></pre></td></tr></table></figure><p>　　该函数可以检索访问或默认ACL，取决于参数<code>type</code>是<code>ACL_TYPE_ACCESS</code>还是<code>ACL_TYPE_DEFAULT</code>。作为结果，<code>acl_get_file()</code>会返回可用于其他ACL函数的句柄 (或<code>acl_t</code>)。</p><p>　　函数<code>acl_set_file()</code>与<code>acl_get_file()</code>相反，它会用参数<code>acl</code>指定的位于内存的ACL的内容来更新位于磁盘的ACL。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> status;</span><br><span class="line">status = acl_set_file(pathname, type, acl);</span><br></pre></td></tr></table></figure><p>　　参数<code>type</code>可以是<code>ACL_TYPE_ACCESS</code> (更新访问ACL) 或<code>ACL_TYPE_DEFAULT</code> (更新目录的默认ACL)。</p><h4 id="检索内存中的acl条目">17.7.2 检索内存中的ACL条目</h4><p>　　函数<code>acl_get_entry()</code>会检索单个位于内存的ACL条目，结果是句柄。该句柄引用参数<code>acl</code>指定的位于内存的ACL条目，并且存储在最后1个参数指向的位置。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">acl_entry_t</span> entry;</span><br><span class="line">status = acl_get_entry(acl, entry_id, &amp;entry);</span><br></pre></td></tr></table></figure><p>　　参数<code>entry_id</code>表示目标条目。若将<code>entry_id</code>指定为<code>ACL_FIRST_ENTRY</code>，则会检索第1个条目；若将<code>entry_id</code>指定为<code>ACL_NEXT_ENTRY</code>，则会检索上一次检索的条目的下一个条目。因此，可以在第1次调用<code>acl_get_entry()</code>时将<code>entry_id</code>指定为<code>ACL_FIRST_ENTRY</code>，后续调用时将<code>entry_id</code>指定为<code>ACL_NEXT_ENTRY</code>，以遍历ACL的所有条目。</p><p>　　若<code>acl_get_entry()</code>成功检索1个ACL条目，则返回0；若没有检索到ACL条目或出错，则返回-1。</p><h4 id="检索和修改acl条目的属性">17.7.3 检索和修改ACL条目的属性</h4><p>　　函数<code>acl_get_tag_type()</code>和<code>acl_set_tag_type()</code>会检索和修改参数<code>entry</code>指定的ALC条目的标签类型。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">acl_tag_t</span> tag_type;</span><br><span class="line">status = acl_get_tag_type(entry, &amp;tag_type);</span><br><span class="line">status = acl_set_tag_type(entry, tag_type);</span><br></pre></td></tr></table></figure><p>　　参数<code>tag_type</code>的数据类型<code>acl_type_t</code>是整数类型，其值只能是<code>ACL_USER_OBJ</code>、<code>ACL_USER</code>、<code>ACL_GROUP_OBJ</code>、<code>ACL_GROUP</code>、<code>ACL_OTHER</code>或<code>ACL_MASK</code>。</p><p>　　函数<code>acl_get_qualifier()</code>和<code>acl_set_qualifier()</code>会检索和修改参数<code>entry</code>指定的ALC条目的标签限定符。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uid_t</span> *qualp;</span><br><span class="line">qualp = acl_get_qualifier(entry);</span><br><span class="line">status = acl_set_qualifier(entry, qualp);</span><br></pre></td></tr></table></figure><p>　　只有条目是<code>ACL_USER</code>或<code>ACL_GROUP</code>条目时，标签限定符才有效。对于<code>ACL_USER</code>条目，参数<code>qualp</code>是指向用户ID的指针 (即<code>uid_t *</code>)。对于<code>ACL_GROUP</code>条目，参数<code>qualp</code>是指向组ID的指针 (即<code>gid_t *</code>)。</p><p>　　函数<code>acl_get_permset()</code>和<code>acl_set_permset()</code>会检索和修改参数<code>entry</code>指定的ALC条目的权限集。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">acl_permset_t</span> permset;</span><br><span class="line">status = acl_get_permset(entry, &amp;permset);</span><br><span class="line">status = acl_set_permset(entry, permset);</span><br></pre></td></tr></table></figure><p>　　数据类型<code>acl_permset_t</code>是引用权限集的句柄。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> is_set;</span><br><span class="line">is_set = acl_get_perm(permset, perm);</span><br><span class="line">status = acl_add_perm(permset, perm);</span><br><span class="line">status = acl_delete_perm(permset, perm);</span><br><span class="line">status = acl_clear_perms(permset);</span><br></pre></td></tr></table></figure><p>　　函数<code>acl_get_perm()</code>、<code>acl_add_perm()</code>、<code>acl_delete_perm()</code>和<code>acl_clear_perms()</code>可用于检索和控制权限集。参数<code>perm</code>只能指定为<code>ACL_READ</code>、<code>ACL_WRITE</code>或<code>ACL_EXECUTE</code>。</p><p>　　● 对于函数<code>acl_get_perm()</code>，若<code>permset</code>指定的权限集包含<code>perm</code>指定的权限，则返回1；否则，返回0。该函数是基于POSIX.1e草案的Linux扩展。</p><p>　　● 函数<code>acl_add_perm()</code>会将<code>perm</code>指定的权限添加到<code>permset</code>指定的权限集。</p><p>　　● 函数<code>acl_delete_perm()</code>会从<code>permset</code>指定的权限集中删除<code>perm</code>指定的权限 (权限集中没有待删除的权限不会导致错误)。</p><p>　　● 函数<code>acl_clear_perms()</code>会清空<code>permset</code>指定的权限集。</p><h4 id="创建和删除acl条目">17.7.4 创建和删除ACL条目</h4><p>　　函数<code>acl_create_entry()</code>会在ALC中创建1个新条目。引用新条目的句柄会存储在第2个参数指向的位置。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">acl_entry_t</span> entry;</span><br><span class="line">status = acl_create_entry(&amp;acl, &amp;entry);</span><br></pre></td></tr></table></figure><p>　　函数<code>acl_delete_entry()</code>会从ACL中删除1个条目。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">status = acl_delete_entry(acl, entry);</span><br></pre></td></tr></table></figure><h4 id="内存中的acl与文本形式acl之间的转换">17.7.5 内存中的ACL与文本形式ACL之间的转换</h4><p>　　函数<code>acl_from_text()</code>会将长文本形式或短文本形式的ACL转换为内存中的ACL，并且返回可用于其他ACL函数的句柄。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acl = acl_from_text(acl_string);</span><br></pre></td></tr></table></figure><p>　　函数<code>acl_to_text()</code>与<code>acl_from_text()</code>相反，返回与参数<code>acl</code>指定的ACL对应的长文本形式字符串。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *str;</span><br><span class="line"><span class="type">ssize_t</span> len;</span><br><span class="line">str = acl_to_text(acl, &amp;len);</span><br></pre></td></tr></table></figure><p>　　若参数<code>len</code>是0，则该参数会存储结果字符串的长度。</p><h4 id="acl-api中的其他函数">17.7.6 ACL API中的其他函数</h4><p>　　函数<code>acl_calc_mask(&amp;acl)</code>会计算和设置参数指向的位于内存的ACL的<code>ACL_MASK</code>条目的权限，通常会在创建或修改ACL时使用该函数。<code>ACL_MASK</code>条目的权限计算为所有<code>ACL_USER</code>、<code>ACL_GROUP</code>和<code>ACL_GROUP_OBJ</code>条目的权限的并集。此外，该函数会在<code>ACL_MASK</code>条目不存在时创建。</p><p>　　对于函数<code>acl_valid(acl)</code>，若参数指定的ACL有效，则返回0；否则，返回-1。有效的ACL需要满足以下条件：</p><p>　　● <code>ACL_USER_OBJ</code>、<code>ACL_GROUP_OBJ</code>和<code>ACL_OTHER</code>条目都只有1个。</p><p>　　● 若存在<code>ACL_USER</code>或<code>ACL_GROUP</code>条目，则有1个<code>ACL_MASK</code>条目；否则，没有<code>ACL_MASK</code>条目。</p><p>　　● 所有<code>ACL_USER</code>条目都对应唯一的用户ID。</p><p>　　● 所有<code>ACL_GROUP</code>条目都对应唯一的组ID。</p><p>　　函数<code>acl_check()</code>和<code>acl_error()</code> (后者是Linux扩展) 是<code>acl_valid()</code>的替代函数，这2个函数的可移植性更差，但对ACL的无效原因提供了更详细的描述。</p><p>　　函数<code>acl_delete_def_file(pathname)</code>会删除参数<code>pathname</code>指定的目录的默认ACL。</p><p>　　函数<code>acl_init(count)</code>会创建1个至少可以容纳<code>count</code>个ACL条目的空ACL结构体 (参数<code>count</code>只是向系统提供相关预期用途的提示，并非限制)，并且返回新ACL的句柄。</p><p>　　函数<code>acl_dup(acl)</code>会复制参数<code>acl</code>指定的ACL，并且返回复制的ACL的句柄。</p><p>　　函数<code>acl_free(obj_p)</code>会释放参数<code>obj_p</code>指向的ACL数据结构的任何可释放的内存 (通常会使用该函数来释放<code>acl_from_text()</code>、<code>acl_to_text()</code>、<code>acl_get_file()</code>、<code>acl_init()</code>和<code>acl_dup()</code>分配的内存)。</p><h4 id="示例程序">17.7.7 示例程序</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* acl_view.c */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;acl/libacl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/acl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ugid_functions.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tlpi_hdr.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">usageError</span><span class="params">(<span class="type">char</span> *progName)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s [-d] filename\n&quot;</span>, progName);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">acl_t</span> acl;</span><br><span class="line">    <span class="type">acl_type_t</span> type;</span><br><span class="line">    <span class="type">acl_entry_t</span> entry;</span><br><span class="line">    <span class="type">acl_tag_t</span> tag;</span><br><span class="line">    <span class="type">uid_t</span> *uidp;</span><br><span class="line">    <span class="type">gid_t</span> *gidp;</span><br><span class="line">    <span class="type">acl_permset_t</span> permset;</span><br><span class="line">    <span class="type">char</span> *name;</span><br><span class="line">    <span class="type">int</span> entryId, permVal, opt;</span><br><span class="line"></span><br><span class="line">    type = ACL_TYPE_ACCESS;</span><br><span class="line">    <span class="keyword">while</span> ((opt = getopt(argc, argv, <span class="string">&quot;d&quot;</span>)) != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (opt)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">            type = ACL_TYPE_DEFAULT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;?&#x27;</span>:</span><br><span class="line">            usageError(argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (optind + <span class="number">1</span> != argc)</span><br><span class="line">    &#123;</span><br><span class="line">        usageError(argv[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    acl = acl_get_file(argv[optind], type);</span><br><span class="line">    <span class="keyword">if</span> (acl == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;acl_get_file&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 遍历ACL的所有条目 */</span></span><br><span class="line">    <span class="keyword">for</span> (entryId = ACL_FIRST_ENTRY;; entryId = ACL_NEXT_ENTRY)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (acl_get_entry(acl, entryId, &amp;entry) != <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">/* 没有ACL条目或出错时退出 */</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 检索和打印标签类型 */</span></span><br><span class="line">        <span class="keyword">if</span> (acl_get_tag_type(entry, &amp;tag) == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;acl_get_tag_type&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-12s&quot;</span>, (tag == ACL_USER_OBJ)    ? <span class="string">&quot;user_obj&quot;</span></span><br><span class="line">                        : (tag == ACL_USER)      ? <span class="string">&quot;user&quot;</span></span><br><span class="line">                        : (tag == ACL_GROUP_OBJ) ? <span class="string">&quot;group_obj&quot;</span></span><br><span class="line">                        : (tag == ACL_GROUP)     ? <span class="string">&quot;group&quot;</span></span><br><span class="line">                        : (tag == ACL_MASK)      ? <span class="string">&quot;mask&quot;</span></span><br><span class="line">                        : (tag == ACL_OTHER)     ? <span class="string">&quot;other&quot;</span></span><br><span class="line">                                                 : <span class="string">&quot;???&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 检索和打印标签限定符 */</span></span><br><span class="line">        <span class="keyword">if</span> (tag == ACL_USER)</span><br><span class="line">        &#123;</span><br><span class="line">            uidp = acl_get_qualifier(entry);</span><br><span class="line">            <span class="keyword">if</span> (uidp == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;acl_get_qualifier&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            name = groupNameFromId(*uidp);</span><br><span class="line">            <span class="keyword">if</span> (name == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%-8d &quot;</span>, *uidp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%-8s &quot;</span>, name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (acl_free(uidp) == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;acl_free&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tag == ACL_GROUP)</span><br><span class="line">        &#123;</span><br><span class="line">            gidp = acl_get_qualifier(entry);</span><br><span class="line">            <span class="keyword">if</span> (gidp == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;acl_get_qualifier&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            name = groupNameFromId(*gidp);</span><br><span class="line">            <span class="keyword">if</span> (name == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%-8d &quot;</span>, *gidp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%-8s &quot;</span>, name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (acl_free(gidp) == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;acl_free&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 检索和打印权限集 */</span></span><br><span class="line">        <span class="keyword">if</span> (acl_get_permset(entry, &amp;permset) == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;acl_get_permset&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        permVal = acl_get_perm(permset, ACL_READ);</span><br><span class="line">        <span class="keyword">if</span> (permVal == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;acl_get_perm - ACL_READ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, (permVal == <span class="number">1</span>) ? <span class="string">&#x27;r&#x27;</span> : <span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">        permVal = acl_get_perm(permset, ACL_WRITE);</span><br><span class="line">        <span class="keyword">if</span> (permVal == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;acl_get_perm - ACL_WRITE&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, (permVal == <span class="number">1</span>) ? <span class="string">&#x27;w&#x27;</span> : <span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">        permVal = acl_get_perm(permset, ACL_EXECUTE);</span><br><span class="line">        <span class="keyword">if</span> (permVal == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;acl_get_perm - ACL_EXECUTE&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, (permVal == <span class="number">1</span>) ? <span class="string">&#x27;x&#x27;</span> : <span class="string">&#x27;-&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (acl_free(acl) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;acl_free&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>　　这个示例展示了部分ACL库函数的用法。该程序会检索和打印文件的ACL (提供了命令<code>getfacl</code>的功能的子集)。若指定了选项<code>-d</code>，则会打印默认ACL，而非访问ACL。</p></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-item"><a href="/linux/the_linux_programming_interface_a_linux_and_unix_system_programming_handbook_chpt_16/" rel="prev" title="《Linux&#x2F;UNIX系统编程手册》第16章 扩展属性"><i class="fa fa-angle-left"></i> 《Linux/UNIX系统编程手册》第16章 扩展属性</a></div><div class="post-nav-item"><a href="/linux/the_linux_programming_interface_a_linux_and_unix_system_programming_handbook_chpt_18/" rel="next" title="《Linux&#x2F;UNIX系统编程手册》第18章 目录和链接">《Linux/UNIX系统编程手册》第18章 目录和链接 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div></div></main><footer class="footer"><div class="footer-inner"></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript></body></html>