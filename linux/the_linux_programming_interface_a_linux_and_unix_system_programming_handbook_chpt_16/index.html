<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple_touch_icon_next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon_32x32_next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_16x16_next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.24.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/serach.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js" defer></script><link rel="canonical" href="http://example.com/linux/the_linux_programming_interface_a_linux_and_unix_system_programming_handbook_chpt_16/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/linux/the_linux_programming_interface_a_linux_and_unix_system_programming_handbook_chpt_16/","path":"linux/the_linux_programming_interface_a_linux_and_unix_system_programming_handbook_chpt_16/","title":"《Linux/UNIX系统编程手册》第16章 扩展属性"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>《Linux/UNIX系统编程手册》第16章 扩展属性 |</title><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script><script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script><script src="/js/third-party/search/local-search.js" defer></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/js/third-party/math/mathjax.js" defer></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title"></p><i class="logo-line"></i></a></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%B1%9E%E6%80%A7%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="nav-text">16.1 扩展属性实现细节</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E6%89%A9%E5%B1%95%E5%B1%9E%E6%80%A7%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="nav-text">16.2 控制扩展属性的系统调用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%92%8C%E4%BF%AE%E6%94%B9ea"><span class="nav-text">16.2.1 创建和修改EA</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A3%80%E7%B4%A2ea%E7%9A%84%E5%80%BC"><span class="nav-text">16.2.2 检索EA的值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4ea"><span class="nav-text">16.2.3 删除EA</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A3%80%E7%B4%A2%E4%B8%8E%E6%96%87%E4%BB%B6%E5%85%B3%E8%81%94%E7%9A%84%E6%89%80%E6%9C%89ea%E7%9A%84%E5%90%8D%E7%A7%B0"><span class="nav-text">16.2.4 检索与文件关联的所有EA的名称</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E7%A8%8B%E5%BA%8F"><span class="nav-text">16.2.5 示例程序</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name"></p><div class="site-description" itemprop="description">这只是个人学习总结，难免出错，欢迎指出，邮箱：concerto-grosso@outlook.com</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">64</span> <span class="site-state-item-name">文章</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div></nav></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/linux/the_linux_programming_interface_a_linux_and_unix_system_programming_handbook_chpt_16/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""><meta itemprop="description" content="这只是个人学习总结，难免出错，欢迎指出，邮箱：concerto-grosso@outlook.com"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="《Linux&#x2F;UNIX系统编程手册》第16章 扩展属性 | null"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">《Linux/UNIX系统编程手册》第16章 扩展属性</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-02-05 00:00:00" itemprop="dateCreated datePublished" datetime="2025-02-05T00:00:00+08:00">2025-02-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-02-10 00:00:00" itemprop="dateModified" datetime="2025-02-10T00:00:00+08:00">2025-02-10</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a> </span></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>6.4k</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>　　<strong>扩展属性</strong> (EA) 允许以名称-值对的形式将任意元数据与文件i-node关联。1个i-node可以关联多个EA。EA于版本2.6添加到Linux。</p><p>　　EA用于实现访问控制列表和文件能力。但是，EA的设计很通用，足以用于其他目的。例如，EA可用于记录文件版本号 (关于文件的MIME类型或字符集的信息) 和指向图标的指针。</p><p>　　SUSv3没有说明EA，但有些UNIX实现提供了类似的特性 (特别是现代BSD和Solaris 9及以上版本)。</p><p>　　EA需要底层文件系统的支持，Btrfs、ext2、ext3、ext4、JFS、Reiserfs和XFS支持EA。但是，这些文件系统对EA的支持都是可选的，由文件系统菜单下的内核配置选项控制。Reiserfs对EA的支持需要Linux 2.6.7及以上版本。</p><p>　　EA的名称格式为<code>namespace.name</code>。命名空间部分用于将EA划分为功能不同的类，名称部分用于区分属于相同命名空间的EA。命名空间的值只能是<code>user</code>、<code>trusted</code>、<code>system</code>或<code>security</code>，分别对应<span style="background-color:#ff0">用户EA</span>、<span style="background-color:#ff0">受信任的EA</span>、<span style="background-color:#ff0">系统EA</span>和<span style="background-color:#ff0">安全EA</span>。</p><p>　　● 用户EA可以由非特权进程控制，受限于文件权限检查 (检索用户EA的值需要文件的读权限，修改用户EA的值需要写权限，没有所需的权限会导致错误<code>EACCES</code>)。为了将用户EA与文件系统ext2、ext3、ext4或Reiserfs中的文件关联，底层文件系统通过命令<code>mount</code>挂载时必须带有选项<code>user_xattr</code>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mount -o user_xattr device directory</span></span><br></pre></td></tr></table></figure><p>　　● 受信任的EA只能由特权进程 (能力<code>CAP_SYS_ADMIN</code>) 控制。</p><p>　　● 系统EA由内核控制，用于将系统对象与文件关联。目前，只有访问控制列表支持该操作。</p><p>　　● 安全EA用于为操作系统安全模块存储文件安全标签和将能力与可执行文件关联。安全EA最初旨在支持安全增强型Linux (SELinux)。</p><p>　　对于<code>user</code>和<code>trusted</code>命名空间，EA名称可以是任意字符串。对于<code>system</code>命名空间，EA名称只能是内核显式允许的名称 (例如，用于访问控制列表的名称)。</p><p>　　JFS支持命名空间<code>os2</code>，其他文件系统都不支持该命名空间。提供<code>os2</code>命名空间是为了支持遗留的OS/2文件系统的EA。创建<code>os2</code>命名空间的EA无需特权。</p><span id="more"></span><p>　　可以通过命令<code>setfattr</code>和<code>getfattr</code>来设置和查看与文件关联的EA。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">touch</span> tfile</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">setfattr -n user.x -v <span class="string">&quot;The past is not dead.&quot;</span> tfile</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">setfattr -n user.y -v <span class="string">&quot;In fact, it&#x27;s not past.&quot;</span> tfile</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">getfattr -n user.x tfile</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">file:tile</span></span><br><span class="line">user.x=&quot;The past is not dead.&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">getfattr -d tfile</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">file:tile</span></span><br><span class="line">user.x=&quot;The past is not dead.&quot;</span><br><span class="line">user.y=&quot;In fact, it&#x27;s not even past.&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">setfattr -n user.x tfile</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">getfattr -d tfile</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">file: tfile</span></span><br><span class="line">user.x</span><br><span class="line">user.y=&quot;In fact, it&#x27;s not even past.&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">setfattr -x user.y tfile</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">getfattr -d tfile</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">file: tfile</span></span><br><span class="line">user.x</span><br></pre></td></tr></table></figure><p>　　第2行的命令会创建单个EA。第4行的命令会检索单个EA的值。第8行的命令会列出与文件关联的所有用户EA。第13行的命令会将指定EA的值修改为空字符串。第19行的命令会删除指定EA。</p><p>　　命令<code>getfattr</code>默认只会列出与文件关联的用户EA的值。选项<code>-m</code>可用于指定待显示的EA名称的正则表达式 (<code>pattern</code>的默认值是<code>^user\.</code>)：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">getfattr -m <span class="string">&#x27;pattern&#x27;</span> file</span></span><br></pre></td></tr></table></figure><p>　　可以使用以下命令来列出与文件关联的所有EA：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">getfattr -m - file</span></span><br></pre></td></tr></table></figure><h3 id="扩展属性实现细节">16.1 扩展属性实现细节</h3><p>　　用户EA只能与文件或目录关联，无法与其他类型的文件的关联，原因如下：</p><p>　　● 对于符号链接，所有用户都拥有所有权限，并且无法修改 (对于Linux，符号链接的权限没有任何意义)。这表示这些权限不能防止用户将用户EA与符号链接关联，这个问题的解决方法就是禁止所有用户将用户EA与符号链接关联。</p><p>　　● 对于设备文件、套接字和有名管道，权限用于对底层对象执行I/O，通过控制权限来控制用户EA的创建与该目的冲突。</p><p>　　此外，非特权进程无法将用户EA与其他用户所有的启用了粘滞位的目录关联，这是为了防止用户将用户EA与<code>/tmp</code>等公共可写且启用了粘滞位的目录关联。</p><p>　　Linux VFS对所有文件系统的EA做出了以下限制：</p><p>　　● EA名最多包含255个字符。</p><p>　　● EA值最大为64KB。</p><p>　　此外，有些文件系统对与文件关联的EA的大小和数量做出了更严格的限制：</p><p>　　● 对于ext2、ext3和ext4，与文件关联的所有EA的名称和值的总字节数不大于单个逻辑磁盘块的大小 (1024、2048和4096字节)。</p><p>　　● 对于JFS，与文件关联的所有EA的名称和值的总字节数上限是128KB。</p><h3 id="控制扩展属性的系统调用">16.2 控制扩展属性的系统调用</h3><h4 id="创建和修改ea">16.2.1 创建和修改EA</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 成功时返回0，出错时返回-1 */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">setxattr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">const</span> <span class="type">void</span> *value, <span class="type">size_t</span> size, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">lsetxattr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">const</span> <span class="type">void</span> *value, <span class="type">size_t</span> size, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fsetxattr</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">const</span> <span class="type">void</span> *value, <span class="type">size_t</span> size, <span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure><p>　　系统调用<code>setxattr()</code>、<code>lsetxattr()</code>和<code>fsetxattr()</code>都会将指定EA设置为指定值，这3个系统调用的区别是指定文件的方式。</p><p>　　● <code>setxattr()</code>通过路径名 (参数<code>pathname</code>) 指定文件，并且当路径名是符号链接时，会解引用。</p><p>　　● <code>lsetxattr()</code>与<code>setxattr()</code>类似，但不会对符号链接解引用。</p><p>　　● <code>fsetxattr()</code>通过打开的文件描述符 (参数<code>fd</code>) 指定文件。</p><p>　　参数<code>name</code>是EA名称字符串 (以字符<code>\0</code>结尾)。EA的新值存储在参数<code>value</code>指向的缓冲区中，该缓冲区的大小由参数<code>size</code>指定。</p><p>　　在默认情况下，若<code>name</code>指定的EA不存在，则这3个系统调用会创建；若存在，则会将其值修改为<code>value</code>指定的值。参数<code>flags</code>可以控制这些行为，其值可以为0 (默认行为)、<code>XATTR_CREATE</code> (若<code>name</code>指定的EA存在，则会导致错误<code>EEXIST</code>) 或<code>XATTR_REPLACE</code> (若<code>name</code>指定的EA不存在，则会导致错误<code>ENODATA</code>)。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *value = <span class="string">&quot;The past is not dead.&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (setxattr(pathname, <span class="string">&quot;user.x&quot;</span>, value, <span class="built_in">strlen</span>(value), <span class="number">0</span>) == <span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    errExit(<span class="string">&quot;setxattr&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>　　这个示例展示了<code>setxattr()</code>的用法。</p><h4 id="检索ea的值">16.2.2 检索EA的值</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 成功时返回EA值的长度 (非负)，出错时返回-1 */</span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">getxattr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">void</span> *value, <span class="type">size_t</span> size)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">lgetxattr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">void</span> *value, <span class="type">size_t</span> size)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">fgetxattr</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">void</span> *value, <span class="type">size_t</span> size)</span>;</span><br></pre></td></tr></table></figure><p>　　系统调用<code>getxattr()</code>、<code>lgetxattr()</code>和<code>fgetxattr()</code>会检索EA的值。这3个系统调用的区别与<code>setxattr()</code>、<code>lsetxattr()</code>和<code>fsetxattr()</code>的区别相同。</p><p>　　参数<code>name</code>是待检索的EA的名称字符串 (以字符<code>\0</code>结尾)。检索结果存储在参数<code>value</code>指向的缓冲区中，该缓冲区必须由调用者分配，并且大小由参数<code>size</code>指定。</p><p>　　这3个系统调用成功时都会将检索结果的长度复制给<code>size</code>。</p><p>　　若与文件的关联EA中没有名为<code>name</code>的EA，则会导致错误<code>ENODATA</code>；若<code>size</code>太小，则会导致错误<code>ERANGE</code>。</p><p>　　<code>size</code>可以指定为0。此时，检索结果不会存储在<code>value</code>指向的缓冲区中，但<code>size</code>还是会包含检索结果的长度。</p><h4 id="删除ea">16.2.3 删除EA</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 成功时返回0，出错时返回-1 */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">removexattr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">lremovexattr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fremovexattr</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br></pre></td></tr></table></figure><p>　　系统调用<code>removexattr()</code>、<code>lremovexattr()</code>和<code>fremovexattr()</code>会删除指定EA。这3个系统调用的区别与<code>setxattr()</code>、<code>lsetxattr()</code>和<code>fsetxattr()</code>的区别相同。</p><p>　　参数<code>name</code>是待删除的EA的名称字符串 (以字符<code>\0</code>结尾)。</p><p>　　若指定的EA不存在，则会导致错误<code>ENODATA</code>。</p><h4 id="检索与文件关联的所有ea的名称">16.2.4 检索与文件关联的所有EA的名称</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 成功时返回复制到list的字节数，出错时返回-1 */</span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">listxattr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">char</span> *<span class="built_in">list</span>, <span class="type">size_t</span> size)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">llistxattr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">char</span> *<span class="built_in">list</span>, <span class="type">size_t</span> size)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">flistxattr</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> *<span class="built_in">list</span>, <span class="type">size_t</span> size)</span>;</span><br></pre></td></tr></table></figure><p>　　系统调用<code>listxattr()</code>、<code>llistxattr()</code>和<code>flistxattr()</code>用于检索与文件关联的所有EA的名称。这3个系统调用的区别与<code>setxattr()</code>、<code>lsetxattr()</code>和<code>fsetxattr()</code>的区别相同。</p><p>　　检索结果作为一系列以字符<code>\0</code>结尾的字符串返回在参数<code>list</code>指向的缓冲区中，该缓冲区的大小由参数<code>size</code>指定。</p><p>　　与<code>getxattr()</code>等系统调用相同，这3个系统调用的<code>size</code>也能指定为0。此时，检索结果不会存储在<code>list</code>指向的缓冲区中，但<code>size</code>还是会包含检索结果的长度。</p><p>　　调用这3个系统调用仅需要能够访问文件 (<code>pathname</code>中的所有目录的执行权限)，不需要文件本身的任何权限。</p><p>　　出于安全，<code>list</code>返回的EA名<span style="background-color:#ff0">可能不包含</span>调用进程无权访问的EA。对于大多数文件系统，当非特权进程调用这3个系统调用时，<code>list</code>返回的EA名不包含受信任的EA的名称，但并非所有文件系统都是如此。因此，当对<code>list</code>中的EA名调用<code>getxattr()</code>等系统调用时，可能会由于没有特权而出错 (另一种可能是在此期间其他进程删除了该EA)。</p><h4 id="示例程序">16.2.5 示例程序</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* xattr_view.c */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tlpi_hdr.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XATTR_SIZE 10000</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">usageError</span><span class="params">(<span class="type">char</span> *progName)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s [-x] file...\n&quot;</span>, progName);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> <span class="built_in">list</span>[XATTR_SIZE], value[XATTR_SIZE];</span><br><span class="line">    <span class="type">ssize_t</span> listLen, valueLen;</span><br><span class="line">    <span class="type">int</span> ns, j, k, opt;</span><br><span class="line">    Boolean hexDisplay;</span><br><span class="line"></span><br><span class="line">    hexDisplay = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((opt = getopt(argc, argv, <span class="string">&quot;x&quot;</span>)) != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (opt)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">            hexDisplay = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;?&#x27;</span>:</span><br><span class="line">            usageError(argv[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (optind &gt;= argc + <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        usageError(argv[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = optind; j &lt; argc; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        listLen = listxattr(argv[j], <span class="built_in">list</span>, XATTR_SIZE);</span><br><span class="line">        <span class="keyword">if</span> (listLen == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;listxattr&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s:\n&quot;</span>, argv[j]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 循环所有EA，打印名称和值 */</span></span><br><span class="line">        <span class="keyword">for</span> (ns = <span class="number">0</span>; ns &lt; listLen; ns += <span class="built_in">strlen</span>(&amp;<span class="built_in">list</span>[ns]) + <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;    name=%s; &quot;</span>, &amp;<span class="built_in">list</span>[ns]);</span><br><span class="line"></span><br><span class="line">            valueLen = getxattr(argv[j], &amp;<span class="built_in">list</span>[ns], value, XATTR_SIZE);</span><br><span class="line">            <span class="keyword">if</span> (valueLen == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;couldn&#x27;t get value&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!hexDisplay)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;value=%.*s&quot;</span>, (<span class="type">int</span>)valueLen, value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;value=&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; valueLen; k++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)value[k]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>　　这个示例会检索和显示与通过命令行参数指定的文件关联的所有EA的名称和值。对于每个文件，程序都会调用<code>listxattr()</code>来检索与该文件关联的EA的名称，然后循环遍历这些EA，每次循环都通过调用<code>getxattr()</code>来检索对应的值。在默认情况下，EA值以文本形式显示。若指定命令行选项<code>-x</code>，则EA值会以十六进制显示。</p></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-item"><a href="/linux/the_linux_programming_interface_a_linux_and_unix_system_programming_handbook_chpt_15/" rel="prev" title="《Linux&#x2F;UNIX系统编程手册》第15章 文件属性"><i class="fa fa-angle-left"></i> 《Linux/UNIX系统编程手册》第15章 文件属性</a></div><div class="post-nav-item"><a href="/linux/the_linux_programming_interface_a_linux_and_unix_system_programming_handbook_chpt_17/" rel="next" title="《Linux&#x2F;UNIX系统编程手册》第17章 访问控制列表">《Linux/UNIX系统编程手册》第17章 访问控制列表 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div></div></main><footer class="footer"><div class="footer-inner"></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript></body></html>